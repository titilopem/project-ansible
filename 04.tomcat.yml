---
- name: Install Apache Tomcat and Java
  hosts: group1
  become: true

  tasks:
    - name: Update package cache on CentOS/RHEL
      package:
        name: "*"
        state: latest
      when: ansible_distribution in ['RedHat', 'Amazon'] and ansible_python.version.major == 3

    - name: Install java-11-openjdk on CentOS/RHEL and Ubuntu
      package:
        name: "{{ item }}"
        state: present
      loop:
        - openjdk-11-jdk
      when: ansible_distribution in ['RedHat', 'CentOS', 'Ubuntu'] and ansible_python.version.major == 3

    - name: Download Apache Tomcat
      get_url:
        url: "https://downloads.apache.org/tomcat/tomcat-10/v10.1.16/bin/apache-tomcat-10.1.16.tar.gz"
        dest: "/tmp/apache-tomcat-10.1.16.tar.gz"

    - name: Extract Tomcat archive
      ansible.builtin.unarchive:
        src: "/tmp/apache-tomcat-10.1.16.tar.gz"
        dest: "/opt"
        remote_src: yes

    - name: Set Tomcat environment variables
      lineinfile:
        path: "/etc/environment"
        line: "CATALINA_HOME=/opt/apache-tomcat-10.1.16"
      become: true

    - name: Set JAVA_HOME using set_fact on CentOS/RHEL
      ansible.builtin.set_fact:
        JAVA_HOME: "/usr/lib/jvm/java-11-openjdk-amd64"
      when: ansible_distribution in ['RedHat', 'CentOS'] and ansible_python.version.major == 3

    - name: Set JAVA_HOME using alternatives on CentOS/RHEL
      ansible.builtin.shell: "alternatives --set java {{ JAVA_HOME }}/bin/java"
      when: ansible_distribution in ['RedHat', 'CentOS'] and ansible_python.version.major == 3

    - name: Systemd - Daemon reload on CentOS/RHEL
      ansible.builtin.systemd:
        daemon_reload: yes
      become: yes
      when: ansible_distribution in ['RedHat', 'CentOS', 'Ubuntu']

    - name: Debug output for systemd check
      ansible.builtin.debug:
        msg: "Systemd is {{ 'present' if 'systemd' in ansible_playbook_python | lower else 'not present' }}"

    - name: Start Tomcat service
      ansible.builtin.shell: "nohup /opt/apache-tomcat-10.1.16/bin/startup.sh"
      when: "'systemd' not in ansible_playbook_python | lower"
      become: true
...