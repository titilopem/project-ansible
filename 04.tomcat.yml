---
- name: Install Java and Apache Tomcat
  hosts: all
  become: true
  gather_facts: true
  tasks:
    - name: Install Java 11 on CentOS
      block:
        - name: Install Java (CentOS)
          yum:
            name: java-11-openjdk-devel
            state: present
      when: "'CentOS' in ansible_distribution"

    - name: Install Java 11 on Ubuntu
      block:
        - name: Install Java (Ubuntu)
          apt:
            name: openjdk-11-jdk
            state: present
      when: "'Ubuntu' in ansible_distribution"

    - name: Install Java 11 on Amazon Linux
      block:
        - name: Install Java (Amazon Linux)
          yum:
            name: java-11-amazon-corretto-devel
            state: present
      when: "'Amazon' in ansible_distribution or 'amzn' in ansible_distribution"

    - name: Set Java Home environment variable
      block:
        - name: Set Java Home (CentOS and Ubuntu)
          lineinfile:
            dest: /etc/environment
            line: 'export JAVA_HOME={{ '/usr/lib/jvm/java-11-openjdk-amd64' if 'Ubuntu' in ansible_distribution else '/usr/lib/jvm/java-11' if 'CentOS' in ansible_distribution else '/usr/lib/jvm/java-11-amazon-corretto' if 'Amazon' in ansible_distribution or 'amzn' in ansible_distribution else '/opt/java' }}'
            create: yes
          notify: reload environment
      when: "'CentOS' in ansible_distribution or 'Ubuntu' in ansible_distribution or 'Amazon' in ansible_distribution or 'amzn' in ansible_distribution"

    - name: Download Apache Tomcat
      block:
        - name: Download Apache Tomcat
          get_url:
            url: "https://downloads.apache.org/tomcat/tomcat-10/v10.1.16/bin/apache-tomcat-10.1.16.tar.gz"
            dest: "/opt/"
      when: "'CentOS' in ansible_distribution or 'Ubuntu' in ansible_distribution or 'Amazon' in ansible_distribution or 'amzn' in ansible_distribution"

    - name: Extract Tomcat archive
      block:
        - name: Extract Tomcat archive
          ansible.builtin.unarchive:
            src: "/opt/apache-tomcat-10.1.16.tar.gz"
            dest: "/opt/"
      when: "'CentOS' in ansible_distribution or 'Ubuntu' in ansible_distribution or 'Amazon' in ansible_distribution or 'amzn' in ansible_distribution"

    - name: Set Tomcat environment variables
      block:
        - name: Set Tomcat environment variables
          lineinfile:
            dest: "/opt/apache-tomcat-10.1.16/bin/setenv.sh"
            line: 'export CATALINA_OPTS="$CATALINA_OPTS -Djava.security.egd=file:/dev/./urandom"'
            create: yes
      when: "'CentOS' in ansible_distribution or 'Ubuntu' in ansible_distribution or 'Amazon' in ansible_distribution or 'amzn' in ansible_distribution"

    - name: System CTL - Daemon reload
      block:
        - name: System CTL - Daemon reload
          systemd:
            daemon_reload: yes
      when: "'CentOS' in ansible_distribution or 'Ubuntu' in ansible_distribution or 'Amazon' in ansible_distribution or 'amzn' in ansible_distribution"

    - name: Debug output for systemd check
      debug:
        msg: "Systemd is not present"
      when: "'CentOS' in ansible_distribution or 'Ubuntu' in ansible_distribution or 'Amazon' in ansible_distribution or 'amzn' in ansible_distribution"

    - name: Start Tomcat service
      block:
        - name: Start Tomcat service
          ansible.builtin.command: "/opt/apache-tomcat-10.1.16/bin/startup.sh"
      when: "'CentOS' in ansible_distribution or 'Ubuntu' in ansible_distribution or 'Amazon' in ansible_distribution or 'amzn' in ansible_distribution"

    - name: Print Tomcat status
      block:
        - name: Print Tomcat status
          ansible.builtin.command: "source /etc/environment && /opt/apache-tomcat-10.1.16/bin/version.sh"
      when: "'CentOS' in ansible_distribution or 'Ubuntu' in ansible_distribution or 'Amazon' in ansible_distribution or 'amzn' in ansible_distribution"

  handlers:
    - name: reload environment
      ansible.builtin.command: "source /etc/environment"
      become: yes
...