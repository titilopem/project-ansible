- name: Gather Facts
  ansible.builtin.setup:

- name: Download Tomcat
  ansible.builtin.get_url:
    url: "https://dlcdn.apache.org/tomcat/tomcat-10/v10.1.16/bin/apache-tomcat-10.1.16.tar.gz"
    dest: "/usr/local"

- name: Extract Tomcat
  ansible.builtin.unarchive:
    src: "/usr/local/apache-tomcat-10.1.16.tar.gz"
    dest: "/usr/local/bin"
    remote_src: yes

- name: Set execute permissions for Tomcat scripts
  ansible.builtin.file:
    path: "/usr/local/bin/apache-tomcat-10.1.16/bin/*.sh"
    mode: 'u+x,g+x'
    recurse: yes

- name: Install Tomcat init script
  ansible.builtin.copy:
    src: "/usr/local/bin/apache-tomcat-10.1.16/bin/catalina.sh"
    dest: "/etc/init.d/tomcat"
    mode: '0755'
    remote_src: yes

- name: Starting Tomcat
  ansible.builtin.command:
    cmd: "{{ catalina_home }}/bin/startup.sh"
  environment:
    CATALINA_HOME: "{{ catalina_home }}"

- name: Check if Tomcat process is running
  ansible.builtin.shell:
    cmd: "ps aux | grep [a]pache-tomcat-10.1.16"
  register: tomcat_process_status
  ignore_errors: true

- name: Print out Tomcat process status
  debug:
    msg: "Tomcat process status: {{ 'Running' if tomcat_process_status.rc == 0 else 'Not running' }}"
